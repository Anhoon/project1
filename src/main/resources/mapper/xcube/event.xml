<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">

<mapper namespace="event">
	
	<select id="selectEventList" resultType="ParamMap">
		SELECT A.* FROM (
			SELECT 
				E.*,
				B.TYPE,
				(CASE TYPE WHEN 'C' THEN '컨벤션' 
									WHEN 'E' THEN '전시회' 
									WHEN 'F' THEN '컨퍼런스' 
									WHEN 'S' THEN '공연' 
									ELSE '미등록코드' END
				) AS TYPE_NM,
				(SELECT TITLE FROM MASTER_LICENSE WHERE OBID = B.MASTER_LICENSE_OBID) AS MASTER_TITLE,
				B.START_DATE,
				B.END_DATE,
				CONCAT(DATE_FORMAT(B.START_DATE,'%Y-%m-%d'),'~',DATE_FORMAT(B.END_DATE,'%Y-%m-%d')) AS LICENSE_DAY
				FROM (
					SELECT 
						A.MASTER_LICENSE_LIST_OBID,
						A.CREATED_ON,
						A.TITLE,
						A.EN_TITLE,
						A.ALIAS,
						A.OBJECTS,
						A.CONTENTS,
						A.SHOW_PRODUCTS,
						A.ORGANIZER,
						A.SUBJECTIVITY,
						A.SUPPORT,
						A.HOMPAGE,
						A.PROGRAM,
						A.ATTATCH_FILE_OBID,
						B.OBJECT_FOR,
						(CASE B.OBJECT_FOR WHEN '0' THEN '전체' WHEN '1' THEN '일반' WHEN '2' THEN '기업' END) OBJECT_FOR_NM,
						(CASE WHEN DATE_FORMAT(SYSDATE(),'%Y-%m-%d') <![CDATA[ <= ]]> DATE_FORMAT(B.END_APPLY_DATE,'%Y-%m-%d') THEN CONCAT('D-',DATEDIFF(B.end_apply_date, B.start_apply_date)) ELSE '모집 완료' END) AS PARTICIPATE_DAY
					FROM EVENT_LIST A, PARTICIPATE_LIST B
					WHERE A.MASTER_LICENSE_LIST_OBID = B.MASTER_LICENSE_LIST_OBID
			) E, MASTER_LICENSE_LIST B
			WHERE E.MASTER_LICENSE_LIST_OBID = B.OBID
		) A
		WHERE 1=1
		<if test="type != null and type != '' " >
			AND TYPE = #{type}
		</if>
		<if test="searchKey != null and searchKey != '' " >
			AND TYPE = #{searchKey}
		</if>
		<if test="searchKeyWord != null and searchKeyWord != '' " >
			AND TYPE = #{searchKeyWord}
		</if>
		<if test="eventType != null and eventType != '' " >
			<if test="eventType == 'ing' " >
				AND DATE_FORMAT(SYSDATE(),'%Y-%m-%d') BETWEEN DATE_FORMAT(A.START_DATE,'%Y-%m-%d') AND DATE_FORMAT(A.END_DATE,'%Y-%m-%d')
			</if>
		</if>
	</select>

	<select id="selectEvent" resultType="ParamMap">
		SELECT 
			MASTER_LICENSE_LIST_OBID,
			DATE_FORMAT(CREATED_ON,'%Y-%m-%d %T') AS CREATED_ON,
			TITLE,
			EN_TITLE,
			ALIAS,
			OBJECTS,
			CONTENTS,
			SHOW_PRODUCTS,
			ORGANIZER,
			SUBJECTIVITY,
			SUPPORT,
			HOMPAGE,
			PROGRAM,
			ATTATCH_FILE_OBID
		FROM EVENT_LIST
		WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
	</select>

	<select id="selectParticipate" resultType="ParamMap">
		SELECT 
			MASTER_LICENSE_LIST_OBID,
			DATE_FORMAT(CREATED_ON,'%Y-%m-%d %T') AS CREATED_ON,
			OBJECT_FOR,
			(CASE OBJECT_FOR WHEN '0' THEN '전체' WHEN '1' THEN '일반' WHEN '2' THEN '기업' END) OBJECT_FOR_NM,
			SCALE,
			QUALIFY_APPLY_OBJECTS,
			DATE_FORMAT(START_APPLY_DATE,'%Y-%m-%d %T') AS START_OBJECTS_DATE,
			DATE_FORMAT(END_APPLY_DATE,'%Y-%m-%d %T') AS END_OBJECTS_DATE,
			SUPPORT_CONTENT,
			APPLY_DOC,
			APPLY_TYPE,
			APPLY_COUNT,
			APPLY_FEE,
			APPLY_FOR_OBJECT,
			ATTATCH_FILE_OBID
		FROM PARTICIPATE_LIST
		WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
	</select>

	<insert id="insertEvent" parameterType="java.util.HashMap">
		INSERT INTO EVENT_LIST
		(
			MASTER_LICENSE_LIST_OBID,
			CREATED_ON,
			TITLE,
			EN_TITLE,
			ALIAS,
			OBJECTS,
			CONTENTS,
			SHOW_PRODUCTS,
			ORGANIZER,
			SUBJECTIVITY,
			SUPPORT,
			HOMPAGE,
			PROGRAM,
			ATTATCH_FILE_OBID
		)
		VALUES 
		(
			#{masterLicenseListObid},
			SYSDATE(),
			#{title},
			#{enTitle},
			#{alias},
			#{objects},
			#{contents},
			#{showProducts},
			#{organizer},
			#{subjectivity},
			#{support},
			#{hompage},
			#{program},
			#{attatchFileObid}
		)
	</insert>

	<insert id="insertParticipate" parameterType="java.util.HashMap">
		INSERT INTO PARTICIPATE_LIST
		(
			MASTER_LICENSE_LIST_OBID,
			CREATED_ON,
			OBJECT_FOR,
			SCALE,
			QUALIFY_APPLY_OBJECTS,
			START_APPLY_DATE,
			END_APPLY_DATE,
			SUPPORT_CONTENT,
			APPLY_DOC,
			APPLY_TYPE,
			APPLY_COUNT,
			APPLY_FEE,
			APPLY_FOR_OBJECT,
			ATTATCH_FILE_OBID
		)
		VALUES 
		(
			#{masterLicenseListObid},
			SYSDATE(),
			#{objectFor},
			#{scale},
			#{qualifyApplyObjects},
			CONVERT(#{startApplyDate}, DATETIME),
			CONVERT(#{endApplyDate}, DATETIME),
			#{supportContent},
			#{applyDoc},
			#{applyType},
			#{applyCount},
			#{applyFee},
			#{applyForObject},
			#{attatchFileObid}
		)
	</insert>

	<update id="updateEvent" parameterType="java.util.HashMap">
		UPDATE EVENT_LIST SET
			TITLE = #{title},
			EN_TITLE = #{enTitle},
			ALIAS = #{alias},
			OBJECTS = #{objects},
			CONTENTS = #{contents},
			SHOW_PRODUCTS = #{showProducts},
			ORGANIZER = #{organizer},
			SUBJECTIVITY = #{subjectivity},
			SUPPORT = #{support},
			HOMPAGE = #{hompage},
			PROGRAM = #{program},
			ATTATCH_FILE_OBID = #{attatchFileObid}
		WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
	</update>

	<update id="updateParticipate" parameterType="java.util.HashMap">
		UPDATE PARTICIPATE_LIST SET
			OBJECT_FOR = #{objectFor},
			QUALIFY_APPLY_OBJECTS = #{qualifyApplyObjects},
			SCALE = #{scale},
			START_APPLY_DATE = CONVERT(#{startApplyDate}, DATETIME),
			END_APPLY_DATE = CONVERT(#{endOApplyDate}, DATETIME),
			SUPPORT_CONTENT = #{supportContent},
			APPLY_DOC = #{applyDoc},
			APPLY_TYPE = #{applyType},
			APPLY_COUNT = #{applyCount},
			APPLY_FEE = #{applyFee},
			APPLY_FOR_OBJECT = #{applyForObject},
			ATTATCH_FILE_OBID = #{attatchFileObid}
		WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
	</update>

	<delete id="deleteEvent" parameterType="java.util.HashMap">
		DELETE FROM EVENT_LIST
		WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
	</delete>

	<delete id="deleteParticipate" parameterType="java.util.HashMap">
		DELETE FROM PARTICIPATE_LIST
		WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
	</delete>

	<select id="selectMyEventList" resultType="ParamMap">
		SELECT A.* FROM (
			SELECT 
				E.*,
				B.TYPE,
				(CASE TYPE WHEN 'C' THEN '컨벤션' 
									WHEN 'E' THEN '전시회' 
									WHEN 'F' THEN '컨퍼런스' 
									WHEN 'S' THEN '공연' 
									ELSE '미등록코드' END
				) AS TYPE_NM,
				(SELECT TITLE FROM MASTER_LICENSE WHERE OBID = B.MASTER_LICENSE_OBID) AS MASTER_TITLE
				FROM (
					SELECT 
						A.MASTER_LICENSE_LIST_OBID,
						A.CREATED_ON,
						A.TITLE,
						A.EN_TITLE,
						A.ALIAS,
						A.OBJECTS,
						A.CONTENTS,
						A.SHOW_PRODUCTS,
						A.ORGANIZER,
						A.SUBJECTIVITY,
						A.SUPPORT,
						A.HOMPAGE,
						A.PROGRAM,
						A.ATTATCH_FILE_OBID,
						B.OBJECT_FOR,
						B.START_APPLY_DATE,
						B.END_APPLY_DATE,
						(CASE B.OBJECT_FOR WHEN '0' THEN '전체' WHEN '1' THEN '일반' WHEN '2' THEN '기업' END) OBJECT_FOR_NM
					FROM EVENT_LIST A, PARTICIPATE_LIST B
					WHERE A.MASTER_LICENSE_LIST_OBID = B.MASTER_LICENSE_LIST_OBID
			) E, MASTER_LICENSE_LIST B
			WHERE E.MASTER_LICENSE_LIST_OBID = B.OBID
			AND B.MASTER_LICENSE_OBID = (SELECT OBID FROM MASTER_LICENSE WHERE EMAIL = 'shine_foryou@hanmail.net')
		) A
		WHERE 1=1
		<if test="type != null and type != '' " >
			<if test="type == 'pre' " >
			AND SYSDATE() BETWEEN SYSDATE() <![CDATA[ < ]]> A.END_APPLY_DATE
			</if>
			<if test="type == 'ing' " >
			AND SYSDATE() BETWEEN A.START_APPLY_DATE AND A.END_APPLY_DATE
			</if>
		</if>
	</select>
</mapper>