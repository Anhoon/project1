<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">

<mapper namespace="manage">

	<!--참가기업-->
	<select id="selectJoinCompanyList" resultType="ParamMap">
		SELECT ROW_NUMBER() OVER() AS NUM,
			   F.COMPANY_NAME,
			   F.IDN,
			   F.EMAIL,
			   REPLACE(REPLACE(REPLACE(REPLACE(F.BUSINESS_TYPE, ']', ''), '[', ''), '"', ''), ' ', '') AS BUSINESS_TYPE,
			   E.REF_OBID,
			   E.REF_OBID_COMPANY
		  FROM MASTER_LICENSE A
	INNER JOIN MASTER_LICENSE_LIST B ON B.REF_OBID = A.OBID
	INNER JOIN EVENT_LIST C ON B.OBID = C.REF_OBID
	INNER JOIN PARTICIPATE_LIST D ON C.REF_OBID = D.REF_OBID
	INNER JOIN TEST_TABLE1 E ON D.REF_OBID = E.REF_OBID
	INNER JOIN USERS F ON E.REF_OBID_COMPANY = F.OBID
		 WHERE A.EMAIL = #{email}
		   AND D.OBJECT_FOR IN (0, 2)
		   AND SYSDATE() BETWEEN B.START_DATE AND END_DATE
		   AND SYSDATE() BETWEEN D.START_OBJECTS_DATE AND END_OBJECTS_DATE
		<if test="searchType == 'companyName'">
		   AND E.COMPANY_NAME LIKE '%'|| #{searchText} || '%'
		</if>
		<if test="searchType == 'comapayType'">
		   AND E.BUSINESS_TYPE LIKE '%' || #{searchText} || '%'
		</if>
		ORDER BY D.CREATED_ON DESC
	</select>

	<select id="selectJoinCompany" resultType="ParamMap">
		SELECT D.*
		  FROM MASTER_LICENSE A
	INNER JOIN EVENT_LIST B ON A.OBID = B.REF_OBID
	INNER JOIN PARTICIPATE_LIST C ON B.REF_OBID = C.REF_OBID
	INNER JOIN TEST_TABLE1 D ON C.REF_OBID = D.REF_OBID
	 LEFT JOIN USERS E ON D.REF_OBID_COMPANY = E.OBID
		 WHERE A.EMAIL = #{email}
		   AND C.OBJECT_FOR IN (0, 2)
		   AND SYSDATE() BETWEEN C.START_OBJECTS_DATE AND END_OBJECTS_DATE
		   AND D.REF_OBID_COMPANY = #{refObidCompany}
	</select>

	<insert id="insertJoinCompany" parameterType="java.util.HashMap">
		INSERT INTO TEST_TABLE1
		(
			REF_OBID,
			REF_OBID_COMPANY,
			TEST1,
			TEST2,
			TEST3,
			ATTACH_OBID,
			CREATED_ON
		)
		VALUES 
		(
			#{refObid},
			#{refObidCompany},
			#{test1},
			#{test2},
			#{test3},
			#{attachObid},
			SYSDATE()
		)
	</insert>

	<update id="updateJoinCompany" parameterType="java.util.HashMap">
		UPDATE TEST_TABLE1
		   SET TEST1 = #{test1},
			   TEST2 = #{test2},
			   TEST3 = #{test3},
			   ATTACH_OBID = #{attachObid}
		 WHERE REF_OBID = #{refObid}
		   AND REF_OBID_COMPANY = #{refObidCompany}
	</update>

	<delete id="deleteJoinCompany" parameterType="java.util.HashMap">
		DELETE FROM TEST_TABLE1
		 WHERE REF_OBID = #{refObid}
		   AND REF_OBID_COMPANY = #{refObidCompany}
	</delete>

	<!--관심기업-->
	<select id="selectInterestCompanyList" resultType="ParamMap">
		SELECT ROW_NUMBER() OVER() AS NUM,
			   F.COMPANY_NAME,
			   F.IDN,
			   F.EMAIL,
			   REPLACE(REPLACE(REPLACE(REPLACE(F.BUSINESS_TYPE, ']', ''), '[', ''), '"', ''), ' ', '') AS BUSINESS_TYPE,
			   E.REF_OBID,
			   E.REF_OBID_COMPANY
		  FROM MASTER_LICENSE A
	INNER JOIN MASTER_LICENSE_LIST B ON B.REF_OBID = A.OBID
	INNER JOIN EVENT_LIST C ON B.OBID = C.REF_OBID
	INNER JOIN PARTICIPATE_LIST D ON C.REF_OBID = D.REF_OBID
	INNER JOIN TEST_TABLE1 E ON D.REF_OBID = E.REF_OBID
	INNER JOIN USERS F ON E.REF_OBID_COMPANY = F.OBID
		 WHERE A.EMAIL = #{email}
		   AND D.OBJECT_FOR IN (0, 2)
		   AND SYSDATE() BETWEEN B.START_DATE AND END_DATE
		   AND SYSDATE() BETWEEN D.START_OBJECTS_DATE AND END_OBJECTS_DATE
	  ORDER BY D.CREATED_ON DESC
	</select>

	<select id="selectInterestCompany" resultType="ParamMap">
		SELECT *  
	      FROM TEST_TABLE
		 WHERE REF_OBID = #{refObid}
		   AND REF_OBID_COMPANY = #{refObidCompany}
	</select>

	<insert id="insertInterestCompany" parameterType="java.util.HashMap">
		INSERT INTO TEST_TABLE
		(
			REF_OBID,
			REF_OBID_COMPANY,
			CREATED_ON
		)
		VALUES 
		(
			#{refObid},
			#{refObidCompany},
			SYSDATE()
		)
	</insert>

	<delete id="deleteInterestCompany" parameterType="java.util.HashMap">
		DELETE FROM TEST_TABLE
		 WHERE REF_OBID = #{refObid}
		   AND REF_OBID_COMPANY = #{refObidCompany}
	</delete>

	<!--참여인력-->
	<select id="selectJoinUserList" resultType="ParamMap">
		SELECT ROW_NUMBER() OVER() AS NUM,
			   F.EMAIL,
			   F.NAME,
			   'TEST' AS ROLL,
			   E.REF_OBID,
			   E.REF_OBID_USER
		  FROM MASTER_LICENSE A
	INNER JOIN MASTER_LICENSE_LIST B ON B.REF_OBID = A.OBID
	INNER JOIN EVENT_LIST C ON B.OBID = C.REF_OBID
	INNER JOIN PARTICIPATE_LIST D ON C.REF_OBID = D.REF_OBID
	INNER JOIN TEST_TABLE1 E ON D.REF_OBID = E.REF_OBID
	INNER JOIN USERS F ON E.REF_OBID_COMPANY = F.OBID
		 WHERE A.EMAIL = #{email}
		   AND D.OBJECT_FOR IN (0, 2)
		   AND SYSDATE() BETWEEN B.START_DATE AND END_DATE
		   AND SYSDATE() BETWEEN D.START_OBJECTS_DATE AND END_OBJECTS_DATE
		<if test="searchType == 'id'">
		   AND D.EMAIL LIKE '%'|| #{searchText} || '%'
		</if>
		<if test="searchType == 'nickName'">
		   AND A.NAME LIKE '%' || #{searchText} || '%'
		</if>
		ORDER BY CREATED_ON DESC
	</select>

	<select id="selectJoinUser" resultType="ParamMap">
		SELECT D.*
		  FROM MASTER_LICENSE A
	INNER JOIN EVENT_LIST B ON A.OBID = B.REF_OBID
	INNER JOIN PARTICIPATE_LIST C ON B.REF_OBID = C.REF_OBID
	INNER JOIN TEST_TABLE1 D ON C.REF_OBID = D.REF_OBID
	 LEFT JOIN USERS E ON D.REF_OBID_USER = E.OBID
		 WHERE A.EMAIL = #{email}
		   AND C.OBJECT_FOR IN (0, 1)
		   AND SYSDATE() BETWEEN C.START_OBJECTS_DATE AND END_OBJECTS_DATE
		   AND D.REF_OBID_USER = #{refObidUser}
	</select>

	<insert id="insertJoinUser" parameterType="java.util.HashMap">
		INSERT INTO TEST_TABLE1
		(
			REF_OBID,
			REF_OBID_USER,
			TEST1,
			TEST2,
			TEST3,
			ATTACH_OBID,
			CREATED_ON
		)
		VALUES 
		(
			#{refObid},
			#{refObidUser},
			#{test1},
			#{test2},
			#{test3},
			#{attachObid},
			SYSDATE()
		)
	</insert>

	<update id="updateJoinUser" parameterType="java.util.HashMap">
		UPDATE TEST_TABLE1
		   SET TEST1 = #{test1},
			   TEST2 = #{test2},
			   TEST3 = #{test3},
			   ATTACH_OBID = #{attachObid}
		 WHERE REF_OBID = #{refObid}
		   AND REF_OBID_USER = #{refObidUser}
	</update>

	<delete id="deleteJoinUser" parameterType="java.util.HashMap">
		DELETE FROM TEST_TABLE1
		 WHERE REF_OBID = #{refObid}
		   AND REF_OBID_USER = #{refObidUser}
	</delete>
</mapper>