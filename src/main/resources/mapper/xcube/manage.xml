<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">

<mapper namespace="manage">

	<!--참가신청관리-->
	<select id="selectParticipateManageList" resultType="ParamMap">
		<![CDATA[
			SELECT ROW_NUMBER() OVER() AS NUM, 
			       X.*
			  FROM (
					SELECT B.MASTER_LICENSE_OBID,
						   C.MASTER_LICENSE_LIST_OBID,
						   A.TITLE,
						   IFNULL(F.COMPANY_NAME, F.NAME) AS COMPANY_NAME,
						   E.APPROVAL_CODE,
						   CASE WHEN E.APPROVAL_CODE = 0 THEN '대기' 
						   		WHEN E.APPROVAL_CODE = 1 THEN '승인'
						   		WHEN E.APPROVAL_CODE = -1 THEN '불가'
						   		ELSE E.APPROVAL_CODE
						   END AS APPROVAL_NAME
					  FROM MASTER_LICENSE A
				INNER JOIN MASTER_LICENSE_LIST B ON A.OBID = B.MASTER_LICENSE_OBID
				INNER JOIN EVENT_LIST C ON B.OBID = C.MASTER_LICENSE_LIST_OBID
				INNER JOIN PARTICIPATE_LIST D ON C.MASTER_LICENSE_LIST_OBID = D.MASTER_LICENSE_LIST_OBID
				INNER JOIN PARTICIPATE_COMPANY_LIST E ON D.MASTER_LICENSE_LIST_OBID = E.MASTER_LICENSE_LIST_OBID
				INNER JOIN USERS F ON E.EMAIL = F.EMAIL
					 WHERE B.STATUS <> -1
					   AND D.START_APPLY_DATE <= SYSDATE()
					   AND D.END_APPLY_DATE >= SYSDATE()
		]]>
		<if test="email != null and email !=''">
			   AND A.EMAIL = #{email}
		</if>
		<if test="masterLicenseListObid != null and masterLicenseListObid !=''">
			   AND B.OBID = #{masterLicenseListObid}
		</if>
		<if test="searchKey == 'eventName'">
			   AND A.TITLE LIKE CONCAT('%',#{searchKeyWord},'%')
		</if>
		<if test="searchKey == 'companyName'">
			   AND E.COMPANY_NAME LIKE CONCAT('%',#{searchKeyWord},'%')
		</if>
		<if test="searchKey == 'approvalCode'">
			   AND E.APPROVAL_CODE = #{searchKeyWord}
		</if>
		<![CDATA[
				ORDER BY D.CREATED_ON DESC
			) X
		]]>
	</select>

	<select id="selectParticipateManage" resultType="ParamMap">
		SELECT A.MASTER_LICENSE_LIST_OBID,
			   DATE_FORMAT(A.CREATED_ON,'%Y-%m-%d %T') AS CREATED_ON,
			   A.EMAIL,
			   A.NAME,
			   A.USER_TYPE,
			   A.APPROVAL_CODE,
			   CASE WHEN A.APPROVAL_CODE = 0 THEN '대기' 
			   		WHEN A.APPROVAL_CODE = 1 THEN '승인'
			   		WHEN A.APPROVAL_CODE = -1 THEN '불가'
			   		ELSE A.APPROVAL_CODE
			   END AS APPROVAL_NAME,
			   A.COMPANY_NAME,
			   A.HOMEPAGE,
			   A.OWNER,
			   A.IDN,
			   A.MANAGER_NAME,
			   A.MANAGER_JOB_POSITION,
			   A.MANAGER_EMAIL,
			   A.MANAGER_TEL,
			   A.ADDR,
			   A.INTRODUCE,
			   A.COMPANY_MAIN_OBJECTS,
			   A.ATTATCH_FILE_OBID
		  FROM PARTICIPATE_COMPANY_LIST A
		 WHERE A.MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
		   AND A.EMAIL = #{email}
	</select>

	<insert id="insertParticipateManage" parameterType="java.util.HashMap">
		INSERT INTO PARTICIPATE_COMPANY_LIST
		(
			MASTER_LICENSE_LIST_OBID,
			CREATED_ON,
			EMAIL,
			NAME,
			USER_TYPE,
			APPROVAL_CODE,
			COMPANY_NAME,
			HOMEPAGE,
			OWNER,
			IDN,
			MANAGER_NAME,
			MANAGER_JOB_POSITION,
			MANAGER_EMAIL,
			MANAGER_TEL,
			ADDR,
			INTRODUCE,
			COMPANY_MAIN_OBJECTS,
			ATTATCH_FILE_OBID
		)
		VALUES 
		(
			#{masterLicenseListObid},
			SYSDATE(),
			#{email},
			#{name},
			#{userType},
			#{approvalCode},
			#{companyName},
			#{homepage},
			#{owner},
			#{idn},
			#{managerName},
			#{managerJobPosition},
			#{managerEmail},
			#{managerTel},
			#{addr},
			#{introduce},
			#{companyMainObjects},
			#{attatchFileObid}
		)
	</insert>

	<update id="updateParticipateManage" parameterType="java.util.HashMap">
		UPDATE PARTICIPATE_COMPANY_LIST
		   SET NAME = #{name},
			   USER_TYPE = #{userType},
			   COMPANY_NAME = #{companyName},
			   HOMEPAGE = #{homepage},
			   OWNER = #{owner},
			   IDN = #{idn},
			   MANAGER_NAME = #{managerName},
			   MANAGER_JOB_POSITION = #{managerJobPosition},
			   MANAGER_EMAIL = #{managerEmail},
			   MANAGER_TEL = #{managerTel},
			   ADDR = #{addr},
			   INTRODUCE = #{introduce},
			   COMPANY_MAIN_OBJECTS = #{companyMainObjects},
			   ATTATCH_FILE_OBID = #{attatchFileObid}
		 WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
		   AND EMAIL = #{email}
	</update>

	<update id="updateParticipateManageApproval" parameterType="java.util.HashMap">
		UPDATE PARTICIPATE_COMPANY_LIST
		   SET APPROVAL_CODE = #{approvalCode}
		 WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
		   AND EMAIL = #{email}
	</update>

	<delete id="deleteParticipateManage" parameterType="java.util.HashMap">
		DELETE FROM PARTICIPATE_COMPANY_LIST
		 WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
		   AND EMAIL = #{email}
	</delete>

	<!--권한관리-->
	<select id="selectAuthManageList" resultType="ParamMap">
		<![CDATA[
			SELECT ROW_NUMBER() OVER() AS NUM, 
			       X.*
			  FROM (
					SELECT B.MASTER_LICENSE_OBID,
						   C.MASTER_LICENSE_LIST_OBID,
						   A.TITLE,
						   E.EMAIL,
						   E.NAME,
						   E.REQ_GRADE,
						   CASE WHEN E.REQ_GRADE = 'A' THEN '행사관리' 
						   		WHEN E.REQ_GRADE = 'B' THEN '부스관리자'
						   		ELSE E.REQ_GRADE
						   END AS REQ_GRADE_NAME,
						   E.GRADE,
						   CASE WHEN E.GRADE = 'A' THEN '행사관리' 
						   		WHEN E.GRADE = 'B' THEN '부스관리자'
						   		ELSE E.GRADE
						   END AS GRADE_NAME
					  FROM MASTER_LICENSE A
				INNER JOIN MASTER_LICENSE_LIST B ON A.OBID = B.MASTER_LICENSE_OBID
				INNER JOIN EVENT_LIST C ON B.OBID = C.MASTER_LICENSE_LIST_OBID
				INNER JOIN PARTICIPATE_LIST D ON C.MASTER_LICENSE_LIST_OBID = D.MASTER_LICENSE_LIST_OBID
				INNER JOIN PARTICIPATE_USER_LIST E ON D.MASTER_LICENSE_LIST_OBID = E.MASTER_LICENSE_LIST_OBID
				INNER JOIN USERS F ON E.EMAIL = F.EMAIL
					 WHERE B.STATUS <> -1
					   AND D.START_APPLY_DATE <= SYSDATE()
					   AND D.END_APPLY_DATE >= SYSDATE()
		]]>
		<if test="email != null and email != ''">
		    AND A.EMAIL = #{email}
		</if>
		<if test="masterLicenseListObid != null and masterLicenseListObid !=''">
			AND B.OBID = #{masterLicenseListObid}
		</if>
		<if test="searchKey == 'id'">
		    AND D.EMAIL LIKE CONCAT('%',#{searchKeyWord},'%')
		</if>
		<if test="searchKey == 'name'">
		    AND A.NAME LIKE CONCAT('%',#{searchKeyWord},'%')
		</if>
		<![CDATA[
					ORDER BY E.CREATED_ON DESC
					)X
		]]>	
	</select>

	<select id="selectAuthManage" resultType="ParamMap">
		SELECT A.MASTER_LICENSE_LIST_OBID,
				DATE_FORMAT(A.CREATED_ON,'%Y-%m-%d %T') AS CREATED_ON,
				A.EMAIL,
				A.NAME,
				A.REQ_GRADE,
				A.GRADE
			FROM PARTICIPATE_USER_LIST A
			WHERE A.EMAIL = #{email}
			AND A.MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
	</select>

	<insert id="insertAuthManage" parameterType="java.util.HashMap">
		INSERT INTO PARTICIPATE_USER_LIST
		(
			MASTER_LICENSE_LIST_OBID,
			CREATED_ON,
			EMAIL,
			NAME,
			REQ_GRADE,
			GRADE
		)
		VALUES 
		(
			#{masterLicenseListObid},
			SYSDATE(),
			#{email},
			#{name},
			#{reqGrade},
			#{grade}
		)
	</insert>

	<update id="updateAuthManage" parameterType="java.util.HashMap">
		UPDATE PARTICIPATE_USER_LIST
		   SET NAME = #{name},
			   REQ_GRADE = #{reqGrade},
			   GRADE = #{grade}
		 WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
		   AND EMAIL = #{email}
	</update>

	<update id="updateAuthManageAuth" parameterType="java.util.HashMap">
		UPDATE PARTICIPATE_USER_LIST
		   SET GRADE = #{grade}
		 WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
		   AND EMAIL = #{email}
	</update>

	<delete id="deleteAuthManage" parameterType="java.util.HashMap">
		DELETE FROM PARTICIPATE_USER_LIST
		 WHERE MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid}
		   AND EMAIL = #{email}
	</delete>

	<!--3D제작요청관리-->
	<select id="select3DManageList" resultType="ParamMap">
		<![CDATA[
			SELECT ROW_NUMBER() OVER() AS NUM, 
			       X.*
			  FROM (
					SELECT B.MASTER_LICENSE_OBID,
						   C.MASTER_LICENSE_LIST_OBID,
						   C.OBID,
						   A.TITLE,
						   C.EMAIL,
						   C.FILE_NAME,
						   C.FILE_TYPE,
						   C.FILE_DESCRIPT,
						   C.ATTATCH_FILE_OBID,
						   C.IMG_ATTATCH_FILE_OBID
					  FROM MASTER_LICENSE A
				INNER JOIN MASTER_LICENSE_LIST B ON A.OBID = B.MASTER_LICENSE_OBID
				INNER JOIN REQ_3D_DATA_LIST C ON B.OBID = C.MASTER_LICENSE_LIST_OBID
					 WHERE B.STATUS <> -1
		]]>
		<if test="email != null and email != ''">
		    AND A.EMAIL = #{email}
		</if>
		<if test="masterLicenseListObid != null and masterLicenseListObid !=''">
			AND B.OBID = #{masterLicenseListObid}
		</if>
		<if test="searchKey == 'title'">
		    AND A.TITLE LIKE CONCAT('%',#{searchKeyWord},'%')
		</if>
		<if test="searchKey == 'fileType'">
		    AND C.FILE_TYPE LIKE CONCAT('%',#{searchKeyWord},'%')
		</if>
		<![CDATA[
				ORDER BY C.CREATED_ON DESC
					) X
		]]>	
	</select>

	<select id="select3DManage" resultType="ParamMap">
		SELECT A.OBID,
			   A.MASTER_LICENSE_LIST_OBID,
			   DATE_FORMAT(A.CREATED_ON,'%Y-%m-%d %T') AS CREATED_ON,
			   A.EMAIL,
			   A.FILE_NAME,
			   A.FILE_TYPE,
			   CASE WHEN A.FILE_TYPE = 'P' THEN '포스터' 
			   		WHEN A.FILE_TYPE = 'I' THEN '소개영상'
			   		WHEN A.FILE_TYPE = 'B' THEN '브로슈어'
					WHEN A.FILE_TYPE = 'PI' THEN '제품이미지'
					WHEN A.FILE_TYPE = 'D' THEN '일반문서'
					WHEN A.FILE_TYPE = 'BN' THEN '배너이미지'
			   		ELSE A.FILE_TYPE
			   END AS FILE_TYPE_NAME,
			   A.FILE_DESCRIPT,
			   A.ATTATCH_FILE_OBID,
			   A.IMG_ATTATCH_FILE_OBID
		  FROM REQ_3D_DATA_LIST A
		 WHERE A.OBID = #{obid}
	</select>

	<insert id="insert3DManage" parameterType="java.util.HashMap">
		INSERT INTO REQ_3D_DATA_LIST
		(
			OBID,
			MASTER_LICENSE_LIST_OBID,
			CREATED_ON,
			EMAIL,
			FILE_NAME,
			FILE_TYPE,
			FILE_DESCRIPT,
			ATTATCH_FILE_OBID,
			IMG_ATTATCH_FILE_OBID
		)
		VALUES 
		(
			#{obid},
			#{masterLicenseListObid},
			SYSDATE(),
			#{email},
			#{fileName},
			#{fileType},
			#{fileDescript},
			#{attatchFileObid},
			#{imgAttatchFileObid}
		)
	</insert>

	<update id="update3DManage" parameterType="java.util.HashMap">
		UPDATE REQ_3D_DATA_LIST
		   SET MASTER_LICENSE_LIST_OBID = #{masterLicenseListObid},
		       FILE_NAME = #{fileName},
			   FILE_TYPE = #{fileType},
			   FILE_DESCRIPT = #{fileDescript},
			   ATTATCH_FILE_OBID = #{attatchFileObid},
			   IMG_ATTATCH_FILE_OBID = #{imgAttatchFileObid}
		 WHERE OBID = #{obid}
	</update>

	<delete id="delete3DManage" parameterType="java.util.HashMap">
		DELETE FROM REQ_3D_DATA_LIST
		 WHERE OBID = #{obid}
	</delete>

	<delete id="delete3DManageList" parameterType="java.util.HashMap">
		DELETE FROM REQ_3D_DATA_LIST
		 WHERE OBID IN 
		 <foreach collection="list" item="item" open="(" separator="," close=")">
			#{item.obid}
		</foreach>
	</delete>
</mapper>