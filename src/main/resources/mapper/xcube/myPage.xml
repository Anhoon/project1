<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">

<mapper namespace="myPage">
	
	<select id="selectMyEventList" resultType="ParamMap">
		SELECT A.* FROM (
			SELECT
				A.OBID,
				A.EMAIL,
				B.OBID AS MASTER_LICENSE_LIST_OBID,
				B.MASTER_LICENSE_OBID,
				A.TITLE,
				B.START_DATE,
				B.END_DATE
			FROM MASTER_LICENSE A, MASTER_LICENSE_LIST B
			WHERE A.OBID = B.MASTER_LICENSE_OBID
			AND A.EMAIL = #{email}
			<if test="eventType != null and eventType != '' " >
				<if test="eventType == 'pre' " >
				AND DATE_FORMAT(B.END_DATE,'%Y-%m-%d') <![CDATA[ < ]]> DATE_FORMAT(SYSDATE(),'%Y-%m-%d') 
				</if>
				<if test="eventType == 'ing' " >
				AND DATE_FORMAT(SYSDATE(),'%Y-%m-%d') BETWEEN DATE_FORMAT(B.START_DATE,'%Y-%m-%d') AND DATE_FORMAT(B.END_DATE,'%Y-%m-%d')
				</if>
			</if>
			ORDER BY A.CREATED_ON DESC
		) A
	</select>

	<select id="participateCompanyHist" resultType="ParamMap">
		SELECT A.* FROM (
		SELECT
			A.OBID,
			A.EMAIL,
			B.OBID AS LISTOBID,
			B.MASTER_LICENSE_OBID,
			A.TITLE
		FROM MASTER_LICENSE A, MASTER_LICENSE_LIST B, PARTICIPATE_COMPANY_LIST C
		WHERE A.OBID = B.MASTER_LICENSE_OBID
		AND B.OBID = C.MASTER_LICENSE_LIST_OBID
		AND A.EMAIL = #{email}
		<if test="searchKey == 'eventName'">
			AND A.TITLE LIKE CONCAT('%',#{searchKeyWord},'%')
		</if>
		ORDER BY C.CREATED_ON DESC
		) A
	</select>

	<select id="participateUserHist" resultType="ParamMap">
		SELECT A.* FROM (
			SELECT
				A.OBID,
				A.EMAIL,
				B.OBID AS LISTOBID,
				B.MASTER_LICENSE_OBID,
				A.TITLE,
				C.REQ_GRADE
			FROM MASTER_LICENSE A, MASTER_LICENSE_LIST B, PARTICIPATE_USER_LIST C
			WHERE A.OBID = B.MASTER_LICENSE_OBID
			AND B.OBID = C.MASTER_LICENSE_LIST_OBID
			AND A.EMAIL = #{email}
			<if test="searchKey == 'eventName'">
				AND A.TITLE LIKE CONCAT('%',#{searchKeyWord},'%')
			</if>
			ORDER BY C.CREATED_ON DESC
		) A
	</select>

	<insert id="insertParticipateUser" parameterType="java.util.HashMap">
		INSERT INTO PARTICIPATE_USER_LIST
		(
			MASTER_LICENSE_LIST_OBID,
			CREATED_ON,
			EMAIL,
			NAME,
			REQ_GRADE,
			GRADE
		)
		VALUES 
		(
			#{masterLicenseListObid},
			SYSDATE(),
			#{email},
			#{name},
			#{reqGrade},
			#{grade}
		)
	</insert>

</mapper>